#include <stdio.h>
#include <string.h>
#include <openssl/evp.h>
#include <dirent.h>

// Function to print the hex representation of data
void printHex(const unsigned char* data, size_t len) {
    for (size_t i = 0; i < len; i++) {
        printf("%02x", data[i]);
    }
    printf("\n");
}

// Function to perform AES encryption
void aesEncrypt(const unsigned char* plaintext, int plaintextLen, const unsigned char* key, unsigned char* ciphertext) {
    EVP_CIPHER_CTX* ctx;
    int ciphertextLen, len;

    ctx = EVP_CIPHER_CTX_new();
    EVP_EncryptInit_ex(ctx, EVP_aes_128_ecb(), NULL, key, NULL);
    EVP_EncryptUpdate(ctx, ciphertext, &len, plaintext, plaintextLen);
    ciphertextLen = len;
    EVP_EncryptFinal_ex(ctx, ciphertext + len, &len);
    ciphertextLen += len;
    EVP_CIPHER_CTX_free(ctx);
}

// Function to scan all files within a directory and its subdirectories
void scanDirectory(const char* directory, const unsigned char* key) {
    DIR* dir = opendir(directory);
    if (dir) {
        struct dirent* entry;
        while ((entry = readdir(dir)) != NULL) {
            if (entry->d_type == DT_REG) { // Check if it's a regular file
                char filepath[256];
                snprintf(filepath, sizeof(filepath), "%s/%s", directory, entry->d_name);

                // Read file content
                FILE* file = fopen(filepath, "r");
                if (file) {
                    fseek(file, 0, SEEK_END);
                    int fileSize = ftell(file);
                    fseek(file, 0, SEEK_SET);

                    unsigned char* fileContent = (unsigned char*)malloc(fileSize);
                    fread(fileContent, 1, fileSize, file);
                    fclose(file);

                    // Encrypt file content
                    unsigned char encrypted[128];
                    aesEncrypt(fileContent, fileSize, key, encrypted);
                    printf("Encrypted file content of '%s': ", filepath);
                    printHex(encrypted, sizeof(encrypted));

                    free(fileContent);
                }
            } else if (entry->d_type == DT_DIR && strcmp(entry->d_name, ".") != 0 && strcmp(entry->d_name, "..") != 0) {
                char subdir[256];
                snprintf(subdir, sizeof(subdir), "%s/%s", directory, entry->d_name);
                scanDirectory(subdir, key);
            }
        }
        closedir(dir);
    }
}

int main() {
    // Encryption key (128 bits / 16 bytes)
    unsigned char key[] = "ThisIsTheSecretKey";

    // AES Encryption of the data
    const unsigned char plaintext[] = "Aplaintext message";
    unsigned char ciphertext[128];
    aesEncrypt(plaintext, strlen((const char*)plaintext), key, ciphertext);
    printf("Ciphertext: ");
    printHex(ciphertext, sizeof(ciphertext));

    // Step 3: File Scanning (For Educational Purposes Only)
    const char* targetDirectory = "/path/to/scan";
    printf("\nStep 3: Scanning all files in directory: %s\n", targetDirectory);
    scanDirectory(targetDirectory, key);

    return 0;
}
